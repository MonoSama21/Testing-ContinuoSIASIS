name: FrontEnd Test - Integracion

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Ingrese el nombre del tag del escenario
        required: true
        type: string
        default: "@test"
      correo:
        description: Ingrese el correo donde llegar√° la notificaci√≥n
        required: true
        type: string
        default: "2101010261@undc.edu.pe"
        
  schedule:
    # Lunes a Viernes 8 AM ‚Äî Tag diario
    - cron: "0 13 * * 1-5"   # 13 UTC = 8AM Per√∫
    # S√°bado y Domingo 7 PM ‚Äî Tag de fin de semana
    - cron: "0 6 * * 6,0"    # 00 UTC = 1:00AM Per√∫

jobs:
  Pruebas-FrontEnd-Integracion:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write  # üëà Permiso para hacer push a gh-pages
      pages: write     # üëà Permiso para desplegar en GitHub Pages
      id-token: write  # üëà Permiso para autenticaci√≥n

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # =========================================================
    # üìå ASIGNAR TAG Y CORREO SEG√öN EL TIPO DE DISPARO
    # =========================================================
    - name: Detectar par√°metros para ejecuci√≥n autom√°tica o manual
      id: params
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
        else
          # Lunes a Viernes
          if [[ $(date +%u) -lt 6 ]]; then
            echo "tag=@DailyTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          else
            # S√°bado y domingo
            echo "tag=@WeekendTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          fi
        fi

    # =========================================================
    # CORREO INICIAL (HTML)
    # =========================================================
    - name: Notificar inicio de ejecuci√≥n
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üîµ Pruebas iniciadas - FrontEnd Integraci√≥n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <h2 style="color:#007bff;">üîµ Ejecuci√≥n iniciada</h2>
            <p>Las pruebas de integraci√≥n han comenzado.</p>
            <p><strong>Tag ejecutado:</strong> <span style="color:#007bff;">${{ steps.params.outputs.tag }}</span></p>
          </div>

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests by tag
      id: run_tests
      run: |
        npm test -- --tags="${{ steps.params.outputs.tag }}"
        echo "resultado=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Generate report
      run: npm run report

    - name: List target directory
      run: ls -R target

    # Subir artefacto completo (con videos) a GitHub Actions
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cucumber-report
        path: target/
        retention-days: 30

    # =========================================================
    # üåê DESPLEGAR REPORTE EN GITHUB PAGES
    # =========================================================
    - name: Preparar reporte para GitHub Pages
      if: always()
      run: |
        mkdir -p gh-pages
        cp target/cucumber-report.html gh-pages/index.html 2>/dev/null || echo "No se encontr√≥ el reporte HTML"
    
    # =========================================================
    # üìä EXTRAER RESULTADOS DEL REPORTE HTML PARA EMAIL
    # =========================================================
    - name: Instalar jsdom para parsear HTML
      if: always()
      run: npm install jsdom
      
    - name: Extraer tabla de resultados del reporte
      if: always()
      run: node .github/scripts/extract-test-results.js
      
    - name: Leer tabla de resultados
      if: always()
      id: test_results
      run: |
        if [ -f test-results-table.html ]; then
          echo "table_html<<EOF" >> $GITHUB_OUTPUT
          cat test-results-table.html >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        else
          echo "table_html=<p>No se pudo generar la tabla de resultados</p>" >> $GITHUB_OUTPUT
        fi
        
    - name: Deploy to GitHub Pages
      if: always()
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./gh-pages
        publish_branch: gh-pages
        force_orphan: true

    # =========================================================
    # üìß CORREO FINAL CON TABLA DE RESULTADOS Y LINK
    # =========================================================
    - name: Notificar fin de ejecuci√≥n con tabla de resultados
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "üü¢ Pruebas finalizadas - FrontEnd Integraci√≥n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" width="180">

            <h2 style="color:#28a745;">üü¢ Pruebas Finalizadas</h2>

            <p><strong>Tag ejecutado:</strong> 
              <span style="color:#28a745;">${{ steps.params.outputs.tag }}</span>
            </p>

            <h3 style="color:#333;">üìä Resultado General:</h3>
            <p>
              Estado: 
              <strong style="color:${{ steps.run_tests.outputs.resultado == '0' && 'green' || 'red' }};">
                ${{ steps.run_tests.outputs.resultado == '0' && 'PASSED' || 'FAILED' }}
              </strong>
            </p>

            ${{ steps.test_results.outputs.table_html }}

            <h3>üìÑ Reporte en vivo:</h3>
            <p>
              üåê <a href="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" 
              style="color:#007bff; font-size: 18px; font-weight: bold;">Ver Reporte HTML Completo</a>
            </p>

            <p>
              üîó <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
              style="color:#007bff;">Ver ejecuci√≥n en GitHub Actions</a>
            </p>
            
            <p>
              üì¶ <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts" 
              style="color:#007bff;">Descargar artefactos (con videos)</a>
            </p>

            <br>
            <p>Saludos,<br><strong>QA Automation Semisenior Yrvin Pachas</strong></p>
          </div>
