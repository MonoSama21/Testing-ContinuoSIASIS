name: FrontEnd Test - Integracion

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Ingrese el nombre del tag del escenario
        required: true
        type: string
        default: "@test"
      correo:
        description: Ingrese el correo donde llegarÃ¡ la notificaciÃ³n
        required: true
        type: string
        default: "2101010261@undc.edu.pe"
        
  schedule:
    # Lunes a Viernes 8 AM â€” Tag diario
    - cron: "0 13 * * 1-5"   # 13 UTC = 8AM PerÃº
    # SÃ¡bado y Domingo 7 PM â€” Tag de fin de semana
    - cron: "0 6 * * 6,0"    # 00 UTC = 1:00AM PerÃº

jobs:
  Pruebas-FrontEnd-Integracion:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # =========================================================
    # ðŸ“Œ ASIGNAR TAG Y CORREO SEGÃšN EL TIPO DE DISPARO
    # =========================================================
    - name: Detectar parÃ¡metros para ejecuciÃ³n automÃ¡tica o manual
      id: params
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          echo "tag=${{ github.event.inputs.tag }}" >> $GITHUB_OUTPUT
          echo "correo=${{ github.event.inputs.correo }}" >> $GITHUB_OUTPUT
        else
          # Lunes a Viernes
          if [[ $(date +%u) -lt 6 ]]; then
            echo "tag=@DailyTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          else
            # SÃ¡bado y domingo
            echo "tag=@WeekendTest" >> $GITHUB_OUTPUT
            echo "correo=2101010261@undc.edu.pe" >> $GITHUB_OUTPUT
          fi
        fi

    # =========================================================
    # CORREO INICIAL (HTML)
    # =========================================================
    - name: Notificar inicio de ejecuciÃ³n
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ðŸ”µ Pruebas iniciadas - FrontEnd IntegraciÃ³n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <h2 style="color:#007bff;">ðŸ”µ EjecuciÃ³n iniciada</h2>
            <p>Las pruebas de integraciÃ³n han comenzado.</p>
            <p><strong>Tag ejecutado:</strong> <span style="color:#007bff;">${{ steps.params.outputs.tag }}</span></p>
          </div>

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    - name: Run Playwright tests by tag
      id: run_tests
      run: |
        npm test -- --tags="${{ steps.params.outputs.tag }}"
        echo "resultado=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    - name: Generate report
      run: npm run report

    - name: List target directory
      run: ls -R target

    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cucumber-report
        path: target/
        retention-days: 30

    # Comprimir reporte
    - name: Comprimir reporte
      if: always()
      run: zip -r reporte.zip target/

    # =========================================================
    # CORREO FINAL CON REPORTE HTML + ZIP
    # =========================================================
    - name: Notificar fin de ejecuciÃ³n y adjuntar reporte
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: "ðŸŸ¢ Pruebas finalizadas - FrontEnd IntegraciÃ³n"
        to: ${{ steps.params.outputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <img src="https://res.cloudinary.com/dvrsdqsl1/image/upload/v1764399269/Blue_Minimalist_Technology_Cube_Logo_1_x445ab.png" width="180">

            <h2 style="color:#28a745;">ðŸŸ¢ Pruebas Finalizadas</h2>

            <p><strong>Tag ejecutado:</strong> 
              <span style="color:#28a745;">${{ steps.params.outputs.tag }}</span>
            </p>

            <h3 style="color:#333;">ðŸ“Š Resultado:</h3>
            <p>
              Estado: 
              <strong style="color:${{ steps.run_tests.outputs.resultado == '0' && 'green' || 'red' }};">
                ${{ steps.run_tests.outputs.resultado == '0' && 'PASSED' || 'FAILED' }}
              </strong>
            </p>

            <h3>ðŸ“„ Reporte:</h3>
            <p>Se adjunta el reporte comprimido y tambiÃ©n puedes verlo como artefacto en GitHub Actions.</p>

            <p>
              ðŸ”— <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
              style="color:#007bff;">Ver ejecuciÃ³n completa en GitHub Actions</a>
            </p>

            <br>
            <p>Saludos,<br><strong>QA Automation Semisenior Yrvin Pachas</strong></p>
          </div>
        attachments: reporte.zip
