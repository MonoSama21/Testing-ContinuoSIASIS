name: FrontEnd Test - Integracion

on:
  workflow_dispatch:
    inputs:
      tag:
        description: Ingrese el nombre del tag del escenario
        required: true
        type: string
      correo:
        description: Ingrese el correo donde llegar谩 la notificaci贸n
        required: true
        type: string

jobs:
  Pruebas-FrontEnd-Integracion:
    timeout-minutes: 60
    runs-on: ubuntu-latest

    steps:

    - uses: actions/checkout@v4

    - uses: actions/setup-node@v4
      with:
        node-version: lts/*

    # ---------------------------------------------------------
    # CORREO HTML INICIO DE PRUEBAS
    # ---------------------------------------------------------
    - name: Notificar inicio de ejecuci贸n
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: " Pruebas iniciadas - FrontEnd Integraci贸n"
        to: ${{ github.event.inputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <h2 style="color:#007bff;"> Ejecuci贸n iniciada</h2>
            <p>Las pruebas de integraci贸n han comenzado.</p>
            <p><strong>Tag ejecutado:</strong> <span style="color:#007bff;">${{ github.event.inputs.tag }}</span></p>
            <br>
            <p> <i>Te avisaremos nuevamente cuando las pruebas finalicen.</i></p>
          </div>

    - name: Install dependencies
      run: npm ci

    - name: Install Playwright Browsers
      run: npx playwright install --with-deps

    # Ejecutar pruebas
    - name: Run Playwright tests by tag
      id: run_tests
      run: |
        npm test -- --tags="${{ github.event.inputs.tag }}"
        echo "resultado=$?" >> $GITHUB_OUTPUT
      continue-on-error: true

    # Generar reporte
    - name: Generate report
      run: npm run report

    - name: List target directory
      run: ls -R target

    # Subir artefacto
    - uses: actions/upload-artifact@v4
      if: always()
      with:
        name: cucumber-report
        path: target/
        retention-days: 30

    # ---------------------------------------------------------
    # COMPRIMIR REPORTE PARA ENVIARLO POR CORREO
    # ---------------------------------------------------------
    - name: Comprimir reporte
      if: always()
      run: zip -r reporte.zip target/

    # ---------------------------------------------------------
    # CORREO HTML FINAL CON RESUMEN + ZIP ADJUNTO
    # ---------------------------------------------------------
    - name: Notificar fin de ejecuci贸n y adjuntar reporte
      if: always()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: ${{ secrets.MAIL_SERVER }}
        server_port: ${{ secrets.MAIL_PORT }}
        username: ${{ secrets.MAIL_USERNAME }}
        password: ${{ secrets.MAIL_PASSWORD }}
        subject: " Pruebas finalizadas - FrontEnd Integraci贸n"
        to: ${{ github.event.inputs.correo }}
        from: ${{ secrets.MAIL_FROM }}
        html_body: |
          <div style="font-family: Arial; padding: 20px;">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/4f/GitHub_logo_2013.svg/2560px-GitHub_logo_2013.svg.png" width="180">

            <h2 style="color:#28a745;"> Pruebas Finalizadas</h2>

            <p><strong>Tag ejecutado:</strong> 
              <span style="color:#28a745;">${{ github.event.inputs.tag }}</span>
            </p>

            <h3 style="color:#333;"> Resultado:</h3>
            <p>
              Estado: 
              <strong style="color:${{ steps.run_tests.outputs.resultado == '0' && 'green' || 'red' }};">
                ${{ steps.run_tests.outputs.resultado == '0' && 'PASSED' || 'FAILED' }}
              </strong>
            </p>

            <h3> Reporte:</h3>
            <p>
              Puedes ver el reporte completo en el artefacto adjunto o descargar el ZIP enviado.
            </p>

            <p>
               <a href="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
              style="color:#007bff;">Ver ejecuci贸n completa en GitHub Actions</a>
            </p>

            <br>
            <p>Saludos,<br><strong>QA Automation Yrvin Pachas</strong></p>
          </div>
        attachments: reporte.zip
